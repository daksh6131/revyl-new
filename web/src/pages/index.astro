---
import Layout from '@/layouts/Layout.astro';
import { getCollection } from 'astro:content';

const posts = await getCollection('blog');
const sortedPosts = posts.sort(
  (a, b) => new Date(b.data.pubDate).valueOf() - new Date(a.data.pubDate).valueOf()
);

const filters = ['All Posts', 'Product', 'Research', 'Guides', 'Changelog'];
---

<Layout title="Blog | Revyl">
  <!-- Title section - more space above like Scalar -->
  <div class="px-6 pt-24 pb-8">
    <h1 class="text-5xl font-bold tracking-tight">Blog</h1>
  </div>

  <!-- Border line -->
  <div class="border-b border-slate-300 dark:border-gray-600"></div>

  <!-- Filter - custom dropdown on mobile, tabs on desktop -->
  <div class="px-6 py-7 border-b border-slate-300 dark:border-gray-600">
    <!-- Mobile custom dropdown -->
    <div class="md:hidden relative">
      <button
        id="filter-dropdown-btn"
        class="w-full px-4 py-3 pr-10 text-sm text-left bg-background border border-slate-300 dark:border-gray-600 cursor-pointer flex items-center justify-between"
      >
        <span id="filter-dropdown-label">All Posts</span>
        <svg class="w-4 h-4 text-muted-foreground transition-transform" id="filter-dropdown-chevron" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
        </svg>
      </button>
      <div id="filter-dropdown-menu" class="absolute top-full left-0 right-0 bg-background border border-t-0 border-slate-300 dark:border-gray-600 z-10 hidden">
        {filters.map((filter, i) => (
          <button
            data-filter={filter === 'All Posts' ? 'all' : filter.toLowerCase()}
            class:list={[
              'mobile-filter-btn w-full px-4 py-3 text-sm text-left hover:bg-muted/50 transition-colors border-b border-slate-200 dark:border-gray-700 last:border-b-0',
              i === 0 ? 'text-[#9D61FF] dark:text-[#C4A1FF]' : 'text-foreground'
            ]}
          >
            {filter}
          </button>
        ))}
      </div>
    </div>

    <!-- Desktop tabs -->
    <div class="hidden md:flex items-center gap-4">
      {filters.map((filter, i) => (
        <button
          data-filter={filter === 'All Posts' ? 'all' : filter.toLowerCase()}
          class:list={[
            'filter-btn px-3 py-1.5 text-sm transition-colors',
            i === 0 ? 'border border-slate-300 dark:border-gray-600' : 'text-muted-foreground hover:text-foreground'
          ]}
        >
          {filter}
        </button>
      ))}
    </div>
  </div>

  <!-- Posts grid - 2 columns with center divider -->
  <div class="grid grid-cols-1 md:grid-cols-2" id="posts-grid">
    {sortedPosts.map((post, i) => {
      const category = post.data.tags[0]?.toLowerCase() || 'product';
      return (
        <a
          href={`/${post.slug}/`}
          data-category={category}
          class="post-item block p-8 lg:p-10 border-b border-slate-300 dark:border-gray-600 hover:bg-muted/50 transition-colors md:border-r"
        >
              <!-- Category and date -->
              <div class="flex items-center justify-between mb-3">
                <span class="text-sm font-medium text-[#9D61FF] dark:text-[#C4A1FF]">
                  {post.data.tags[0] || 'Product'}
                </span>
                <time datetime={post.data.pubDate.toISOString()} class="text-sm text-muted-foreground">
                  {new Date(post.data.pubDate).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'short',
                    day: 'numeric',
                  })}
                </time>
              </div>

              <!-- Title -->
              <h2 class="text-xl lg:text-2xl font-medium mb-4 line-clamp-2">
                {post.data.title}
              </h2>

              <!-- Description -->
              <p class="text-sm lg:text-base text-muted-foreground mb-8 line-clamp-2">
                {post.data.description}
              </p>

              <!-- Author -->
              <div class="text-sm text-muted-foreground">
                {post.data.author || 'Revyl Team'}
              </div>
        </a>
      );
    })}
  </div>

  {sortedPosts.length === 0 && (
    <p class="text-muted-foreground py-12 text-center">No posts yet.</p>
  )}
</Layout>

<style>
  .line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
  }

  .filter-btn.active {
    border: 1px solid rgb(203 213 225); /* slate-300 */
  }

  :global(.dark) .filter-btn.active {
    border-color: rgb(75 85 99); /* gray-600 */
  }

  .post-item.hidden {
    display: none;
  }
</style>

<script is:inline>
  document.addEventListener('DOMContentLoaded', () => {
    const buttons = document.querySelectorAll('.filter-btn');
    const posts = document.querySelectorAll('.post-item');

    // Mobile dropdown elements
    const dropdownBtn = document.getElementById('filter-dropdown-btn');
    const dropdownMenu = document.getElementById('filter-dropdown-menu');
    const dropdownLabel = document.getElementById('filter-dropdown-label');
    const dropdownChevron = document.getElementById('filter-dropdown-chevron');
    const mobileButtons = document.querySelectorAll('.mobile-filter-btn');

    function filterPosts(filter) {
      posts.forEach(post => {
        if (filter === 'all') {
          post.classList.remove('hidden');
        } else {
          const category = post.dataset.category;
          if (category.includes(filter)) {
            post.classList.remove('hidden');
          } else {
            post.classList.add('hidden');
          }
        }
      });
    }

    // Desktop button filters
    buttons.forEach(btn => {
      btn.addEventListener('click', () => {
        buttons.forEach(b => {
          b.classList.remove('active', 'border', 'border-slate-300', 'dark:border-gray-600');
          b.classList.add('text-muted-foreground');
        });
        btn.classList.add('active', 'border', 'border-slate-300', 'dark:border-gray-600');
        btn.classList.remove('text-muted-foreground');
        filterPosts(btn.dataset.filter);
      });
    });

    // Mobile custom dropdown
    if (dropdownBtn && dropdownMenu) {
      dropdownBtn.addEventListener('click', () => {
        const isOpen = !dropdownMenu.classList.contains('hidden');
        if (isOpen) {
          dropdownMenu.classList.add('hidden');
          dropdownChevron.classList.remove('rotate-180');
        } else {
          dropdownMenu.classList.remove('hidden');
          dropdownChevron.classList.add('rotate-180');
        }
      });

      // Close dropdown when clicking outside
      document.addEventListener('click', (e) => {
        if (!dropdownBtn.contains(e.target) && !dropdownMenu.contains(e.target)) {
          dropdownMenu.classList.add('hidden');
          dropdownChevron.classList.remove('rotate-180');
        }
      });

      // Mobile filter buttons
      mobileButtons.forEach(btn => {
        btn.addEventListener('click', () => {
          // Update label
          dropdownLabel.textContent = btn.textContent.trim();

          // Update active state
          mobileButtons.forEach(b => {
            b.classList.remove('text-[#9D61FF]', 'dark:text-[#C4A1FF]');
            b.classList.add('text-foreground');
          });
          btn.classList.remove('text-foreground');
          btn.classList.add('text-[#9D61FF]', 'dark:text-[#C4A1FF]');

          // Close dropdown
          dropdownMenu.classList.add('hidden');
          dropdownChevron.classList.remove('rotate-180');

          // Filter posts
          filterPosts(btn.dataset.filter);
        });
      });
    }
  });
</script>
